// ===== SERVICIO WHATSAPP MEJORADO - NOTIFICACIONES INSTANT√ÅNEAS =====
class WhatsAppService {
    constructor() {
        this.config = {
            adminNumber: '59173811600', // TU N√öMERO
            businessNumber: '59173220922', // N√∫mero de la empresa
            defaultMessage: '¬°Hola! Quiero hacer una reserva en Cancha Ranger'
        };
        this.notificacionesActivas = true;
    }

    // ===== NOTIFICACI√ìN INSTANT√ÅNEA AL ADMIN =====
    async enviarNotificacionInstantanea(reserva) {
        if (!this.notificacionesActivas) return;
        
        const cancha = window.sistema?.canchas.find(c => c.id === reserva.canchaId);
        const horas = reserva.horaFin - reserva.horaInicio;
        
        const mensaje = `üö® *NUEVA RESERVA CONFIRMADA* üö®

üèüÔ∏è *Cancha:* ${cancha?.nombre}
üë§ *Cliente:* ${reserva.usuario.nombre}
üìû *Tel√©fono:* ${reserva.usuario.telefono}
üìß *Email:* ${reserva.usuario.email}

üìÖ *Fecha:* ${this.formatearFechaLegible(reserva.fecha)}
‚è∞ *Horario:* ${reserva.horaInicio}:00 - ${reserva.horaFin}:00
‚è±Ô∏è *Duraci√≥n:* ${horas} hora${horas > 1 ? 's' : ''}
üí∞ *Total:* ${reserva.total} Bs

üî¢ *C√≥digo:* ${reserva.codigoReserva}
üÜî *ID:* ${reserva.id}

üìç *Ubicaci√≥n:* Calle 9 de abril entre Ejercito y Murillo Dorado
‚è∞ *Hora de reserva:* ${new Date().toLocaleString('es-ES')}

_Reserva confirmada autom√°ticamente por el sistema_`;

        await this.enviarMensajeDirecto(this.config.adminNumber, mensaje);
        
        // Tambi√©n enviar al segundo n√∫mero si existe
        if (this.config.businessNumber && this.config.businessNumber !== this.config.adminNumber) {
            await this.enviarMensajeDirecto(this.config.businessNumber, mensaje);
        }
    }

    // ===== ALERTA URGENTE PARA RESERVAS INMEDIATAS =====
    async enviarAlertaUrgente(reserva) {
        const cancha = window.sistema?.canchas.find(c => c.id === reserva.canchaId);
        const ahora = new Date();
        const fechaReserva = new Date(reserva.fecha);
        const diferenciaHoras = (fechaReserva - ahora) / (1000 * 60 * 60);
        
        // Si la reserva es para hoy o ma√±ana, enviar alerta especial
        if (diferenciaHoras < 48) {
            const mensajeUrgente = `üî• *RESERVA URGENTE - HOY/MA√ëANA* üî•

üèüÔ∏è ${cancha?.nombre}
üë§ ${reserva.usuario.nombre}
üìû ${reserva.usuario.telefono}
üìÖ ${this.formatearFechaLegible(reserva.fecha)}
‚è∞ ${reserva.horaInicio}:00 - ${reserva.horaFin}:00

‚ö†Ô∏è *RESERVA PR√ìXIMA - CONFIRMAR DISPONIBILIDAD*`;

            await this.enviarMensajeDirecto(this.config.adminNumber, mensajeUrgente);
        }
    }

    // ===== M√âTODO PRINCIPAL PARA ENVIAR MENSAJES =====
    async enviarMensajeDirecto(numero, mensaje) {
        try {
            const mensajeCodificado = encodeURIComponent(mensaje);
            const urlWhatsApp = `https://wa.me/${numero}?text=${mensajeCodificado}`;
            
            // Abrir en nueva pesta√±a (funciona en m√≥viles y desktop)
            const ventana = window.open(urlWhatsApp, '_blank');
            
            // Cerrar autom√°ticamente despu√©s de 3 segundos (opcional)
            setTimeout(() => {
                if (ventana && !ventana.closed) {
                    ventana.close();
                }
            }, 3000);
            
            console.log('üì± Notificaci√≥n WhatsApp enviada:', { numero, mensaje });
            return true;
            
        } catch (error) {
            console.error('Error enviando WhatsApp:', error);
            return false;
        }
    }

    // ===== CONFIRMACI√ìN AL CLIENTE =====
    async enviarConfirmacionCliente(reserva) {
        const cancha = window.sistema?.canchas.find(c => c.id === reserva.canchaId);
        const horas = reserva.horaFin - reserva.horaInicio;
        
        const mensaje = `‚úÖ *RESERVA CONFIRMADA - CANCHA RANGER* ‚úÖ

¬°Hola ${reserva.usuario.nombre}! Tu reserva ha sido confirmada:

üèüÔ∏è *Cancha:* ${cancha?.nombre}
üìÖ *Fecha:* ${this.formatearFechaLegible(reserva.fecha)}
‚è∞ *Horario:* ${reserva.horaInicio}:00 - ${reserva.horaFin}:00
‚è±Ô∏è *Duraci√≥n:* ${horas} hora${horas > 1 ? 's' : ''}
üí∞ *Total a pagar:* ${reserva.total} Bs

üî¢ *C√≥digo de Reserva:* ${reserva.codigoReserva}

üìç *Ubicaci√≥n:* Calle 9 de abril entre Ejercito y Murillo Dorado
üìû *Contacto:* 73811600 - 73220922
üë§ *Operadora:* Lurdes C√≥rdova

üí° *Importante:*
‚Ä¢ Presenta este c√≥digo al llegar
‚Ä¢ Pago en efectivo en la cancha
‚Ä¢ Llega 15 minutos antes
‚Ä¢ Modificaciones hasta 12h antes

¬°Te esperamos! üéâ`;

        await this.enviarMensajeDirecto(reserva.usuario.telefono, mensaje);
    }

    // ===== SISTEMA DE RECORDATORIOS =====
    programarRecordatorios(reserva) {
        // Recordatorio 24 horas antes
        const recordatorio24h = new Date(reserva.fecha);
        recordatorio24h.setHours(reserva.horaInicio - 24);
        
        // Recordatorio 2 horas antes (solo si es el mismo d√≠a)
        const recordatorio2h = new Date(reserva.fecha);
        recordatorio2h.setHours(reserva.horaInicio - 2);
        
        this.programarRecordatorio(recordatorio24h, reserva, '24 horas');
        this.programarRecordatorio(recordatorio2h, reserva, '2 horas');
    }

    programarRecordatorio(fecha, reserva, tipo) {
        const ahora = new Date();
        const diferencia = fecha - ahora;
        
        if (diferencia > 0) {
            setTimeout(() => {
                this.enviarRecordatorio(reserva, tipo);
            }, diferencia);
        }
    }

    async enviarRecordatorio(reserva, tipo) {
        const mensaje = `‚è∞ *RECORDATORIO - CANCHA RANGER* ‚è∞

¬°Hola ${reserva.usuario.nombre}! Te recordamos tu reserva:

Tu partido es en *${tipo}*
üèüÔ∏è Cancha: ${reserva.canchaId}
üìÖ Fecha: ${this.formatearFechaLegible(reserva.fecha)}
‚è∞ Horario: ${reserva.horaInicio}:00 - ${reserva.horaFin}:00

üî¢ C√≥digo: ${reserva.codigoReserva}

üìç Calle 9 de abril entre Ejercito y Murillo Dorado
üìû 73811600 - 73220922

¬°Te esperamos! üéæ`;

        await this.enviarMensajeDirecto(reserva.usuario.telefono, mensaje);
    }

    // ===== M√âTODOS UTILITARIOS =====
    formatearFechaLegible(fechaISO) {
        const fecha = new Date(fechaISO);
        return fecha.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    // ===== CONFIGURACI√ìN EN TIEMPO REAL =====
    toggleNotificaciones(activo) {
        this.notificacionesActivas = activo;
        console.log(`üîî Notificaciones ${activo ? 'activadas' : 'desactivadas'}`);
    }

    // ===== BOT√ìN FLOTANTE WHATSAPP =====
    crearBotonFlotanteWhatsApp() {
        // Verificar si ya existe el bot√≥n
        if (document.querySelector('.whatsapp-flotante')) {
            return;
        }

        const botonWhatsApp = document.createElement('div');
        botonWhatsApp.className = 'whatsapp-flotante';
        botonWhatsApp.innerHTML = `
            <a href="${this.generarEnlaceConsultaRapida()}" target="_blank" class="whatsapp-link">
                <i class="fab fa-whatsapp"></i>
                <span>Reservar por WhatsApp</span>
            </a>
        `;
        
        document.body.appendChild(botonWhatsApp);
        return botonWhatsApp;
    }

    // ===== BOTONES WHATSAPP EN CANCHAS =====
    agregarBotonesWhatsAppCanchas() {
        const canchasGrid = document.getElementById('canchasGrid');
        if (!canchasGrid) return;

        // Agregar bot√≥n WhatsApp a cada cancha
        document.querySelectorAll('.cancha-card-profesional').forEach((card, index) => {
            const cancha = window.sistema?.canchas[index];
            if (!cancha) return;

            // Verificar si ya existe el bot√≥n
            if (card.querySelector('.btn-whatsapp-cancha')) {
                return;
            }

            const botonWhatsApp = document.createElement('button');
            botonWhatsApp.className = 'btn-whatsapp-cancha';
            botonWhatsApp.innerHTML = `
                <i class="fab fa-whatsapp"></i>
                WhatsApp
            `;
            
            botonWhatsApp.addEventListener('click', (e) => {
                e.stopPropagation();
                const url = this.generarEnlaceConsultaRapida(cancha.id);
                window.open(url, '_blank');
            });

            const acciones = card.querySelector('.cancha-actions');
            if (acciones) {
                acciones.appendChild(botonWhatsApp);
            }
        });
    }

    // ===== GENERAR ENLACES WHATSAPP =====
    generarEnlaceConsultaRapida(canchaId = null) {
        let mensaje = this.config.defaultMessage;
        
        if (canchaId && window.sistema) {
            const cancha = window.sistema.canchas.find(c => c.id === canchaId);
            if (cancha) {
                mensaje = `¬°Hola! Estoy interesado en reservar la *${cancha.nombre}*.\n\n‚Ä¢ Precio: ${cancha.precio} Bs/hora\n‚Ä¢ Tipo: ${cancha.tipo}\n\n¬øPodr√≠an indicarme disponibilidad y proceso de reserva?`;
            }
        }
        
        const mensajeCodificado = encodeURIComponent(mensaje);
        return `https://wa.me/${this.config.businessNumber}?text=${mensajeCodificado}`;
    }

    generarEnlaceReservaDirecta(datosReserva = null) {
        let mensaje = this.config.defaultMessage;
        
        if (datosReserva) {
            const { cancha, fecha, horaInicio, horaFin, nombre, telefono } = datosReserva;
            const horas = horaFin - horaInicio;
            const total = horas * cancha.precio;
            
            mensaje = `üìÖ *SOLICITUD DE RESERVA - CANCHA RANGER* üìÖ

üèüÔ∏è *Cancha de inter√©s:* ${cancha.nombre}
üë§ *Nombre:* ${nombre}
üìû *Tel√©fono:* ${telefono}

üìÜ *Fecha preferida:* ${this.formatearFechaLegible(fecha)}
‚è∞ *Horario preferido:* ${horaInicio}:00 - ${horaFin}:00
‚è±Ô∏è *Duraci√≥n:* ${horas} hora${horas > 1 ? 's' : ''}
üí∞ *Total estimado:* ${total} Bs

üí¨ *Mensaje:* Por favor confirmen disponibilidad y procedimiento de pago.`;
        }
        
        const mensajeCodificado = encodeURIComponent(mensaje);
        return `https://wa.me/${this.config.adminNumber}?text=${mensajeCodificado}`;
    }

    // ===== INICIALIZACI√ìN =====
    init() {
        console.log('üì± Servicio de WhatsApp inicializado - Notificaciones activas');
        this.crearBotonFlotanteWhatsApp();
        
        // Esperar a que carguen las canchas para agregar botones
        setTimeout(() => {
            this.agregarBotonesWhatsAppCanchas();
        }, 2000);
        
        // Verificar cada 30 segundos si hay nuevas reservas pendientes de notificaci√≥n
        setInterval(() => {
            this.verificarReservasPendientes();
        }, 30000);
    }

    verificarReservasPendientes() {
        // En un sistema m√°s avanzado, podr√≠as verificar reservas que no han sido notificadas
        console.log('üîç Verificando reservas pendientes de notificaci√≥n...');
    }
}